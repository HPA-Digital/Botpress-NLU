{"version":3,"sources":["webpack:///webpack/bootstrap 1d36673c4e93ef2a6caa","webpack:///external \"lodash\"","webpack:///external \"crypto\"","webpack:///./src/providers/base.js","webpack:///external \"bluebird\"","webpack:///./src/providers/entities.js","webpack:///external \"axios\"","webpack:///./src/index.js","webpack:///external \"bluebird-retry\"","webpack:///external \"moment\"","webpack:///./src/storage.js","webpack:///external \"mkdirp\"","webpack:///external \"path\"","webpack:///./src/parser.js","webpack:///./src/providers/dialogflow.js","webpack:///external \"dialogflow\"","webpack:///./src/providers/luis.js","webpack:///./src/providers/rasa.js","webpack:///external \"ms\"","webpack:///./src/providers/recast.js","webpack:///./src/providers/native.js","webpack:///external \"zscore\"","webpack:///external \"natural\""],"names":["ENVIRONEMENT","process","env","NODE_ENV","Provider","name","entityKey","logger","config","storage","parser","kvs","isProduction","Error","incomingText","getCustomEntities","_getProviderEntities","_","toPairs","Entities","filter","p","map","isFromProvider","nameProvider","defaultExtractData","intent","confidence","provider","intents","entities","module","exports","intentsDir","type","required","default","entitiesDir","googleProjectId","luisAppId","luisProgrammaticKey","luisAppSecret","luisAppRegion","rasaEndpoint","rasaToken","rasaProject","recastToken","recastUserSlug","recastBotSlug","debugModeEnabled","minimumConfidence","maximumConfidence","nativeAdjustementThreshold","maximumRequestsPerHour","init","bp","configurator","event","includes","JSON","get","previous","parse","hour","startOf","requestsCount","isSame","set","stringify","parseFloat","eventIntent","eventIntents","info","text","raw","extract","retryPolicy","metadata","Object","assign","nlu","warn","message","intentConfidentEnough","MIN_CONFIDENCE","MAX_CONFIDENCE","is","intentName","toLowerCase","startsWith","prefix","has","find","processEvent","loadAll","Storage","initializeGhost","dialogflow","DialogflowProvider","luis","LuisProvider","rasa","RasaProvider","recast","RecastProvider","native","NativeProvider","isNaN","Parser","interval","max_interval","timeout","max_tries","middlewares","register","handler","next","order","description","ready","router","getRouter","delete","req","res","deleteIntent","params","sendStatus","post","saveIntent","body","getIntents","send","getIntent","getAvailableEntities","x","checkSyncNeeded","events","emit","time","sync","status","formatFilename","replace","ghost","ghostManager","projectDir","projectLocation","mkdirp","path","resolve","addRootFolder","filesGlob","content","length","utterancesFile","propertiesFile","utterances","join","upsertFile","deleteFile","code","directoryListing","Promise","mapSeries","filename","readFile","propertiesContent","utterancesContent","split","properties","getCustomEntity","entity","definitionContent","definition","canonicalUtterance","intentEntities","labels","plainText","regex","m","i","exec","substr","index","push","start","end","entityName","projectId","require","agentClient","AgentsClient","sessionClient","SessionsClient","contextClient","ContextsClient","shortUserId","crypto","createHash","update","digest","field","kind","values","_resolveEntity","v","mapValues","fields","f","getAgent","parent","projectPath","agent","request","session","sessionPath","_getSessionId","queryInput","languageCode","defaultLanguageCode","queryParams","sentimentAnalysisRequestConfig","analyzeQueryTextSentiment","detectIntent","detection","queryResult","isSmallTalk","action","displayName","intentDetectionConfidence","parameters","k","value","context","add","lifespan","contextPath","createContextRequest","lifespanCount","createContext","original","position","LUIS_APP_VERSION","LUIS_HASH_KVS_KEY","appId","programmaticKey","appSecret","appRegion","axios","headers","data","version","debug","del","statusCode","response","localIntents","remoteVersion","intentsHash","hash","lastModifiedDateTime","getRemoteVersion","currentVersion","isInSync","getCustomLuisEntities","simples","composites","lists","mapToType","list","providerType","simplesDef","e","compositesDef","listsDef","missingPattern","isEmpty","syncingSince","Date","validateCredentials","deleteVersion","builtinEntities","simpleEntities","compositeEntities","listEntities","availableEntities","forEach","extracted","extractLabelsFromCanonical","utterance","trim","label","indexOf","startPos","endPos","getAppInfo","appInfo","luis_schema_version","versionId","desc","culture","closedLists","bing_entities","model_features","regex_features","result","train","onSyncSuccess","detailedError","error","models","percent","details","modelId","failureReason","toFixed","delay","isStaging","region","incomingEvent","q","verbose","spellCheck","staging","score","unit","startIndex","RASA_HASH_KVS_KEY","endpoint","token","project","client","create","baseURL","_getRemoteVersions","remoteVersions","_isInSync","scope","projectName","_getProjectName","versions","last","sortBy","_modelId","sample","rasa_nlu_data","common_examples","entity_synonyms","_training","msg","errorMsg","_onSyncSuccess","_cacheLatestModel","latestModel","model","extractor","RECAST_HASH_KVS_KEY","Authorization","intentSlug","expressionId","expression","put","gazetteSlug","entity_id","syncing","_getIntentsHash","_getBotModel","results","defaultLanguage","language","isocode","_getRemoteGazettes","remoteGazettes","_deleteGazette","customEntities","_postGazette","remoteGazette","pick","_getRemoteIntents","remoteIntents","_deleteIntent","u","expressions","source","_postIntent","_getBulkCreations","_getRemoteIntentExpressions","remoteIntentExpressions","expr","_getRemoteExpression","id","remoteIntentExpression","word","tokens","t","slug","gazette","_updateRemoteExpression","savedHash","key","entityType","omit","valueSize","size","keys","act","detected","processed","processing_language","sentiment","NATIVE_HASH_KVS_KEY","NATIVE_MODEL","DEFAULT_THRESHOLD","EMPTY_INTENT","classifier","stemmer","customStemmer","isFunction","tokenizeAndStem","_stemText","bind","natural","PorterStemmer","BayesClassifier","restore","getStemmer","samples_count","addDocument","_restoreModel","threshold","classifications","orderBy","getClassifications","allScores","c","s","delta","Math","abs","max"],"mappings":"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","file":"node.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"C:\\\\Users\\\\AranM\\\\Projects\\\\maori\\\\Botpress\\\\Botpress-NLU\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 6);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 1d36673c4e93ef2a6caa","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 0\n// module chunks = 0","module.exports = require(\"crypto\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"crypto\"\n// module id = 1\n// module chunks = 0","const ENVIRONEMENT = process.env.NODE_ENV === 'production' ? 'prod' : 'dev'\r\n\r\nimport Entities from './entities'\r\nimport _ from 'lodash'\r\n\r\nexport default class Provider {\r\n  constructor({ name, entityKey, logger, config, storage, parser, kvs }) {\r\n    this.name = name\r\n    this.entityKey = entityKey\r\n    this.logger = logger\r\n    this.storage = storage\r\n    this.kvs = kvs\r\n    this.config = config\r\n    this.parser = parser\r\n    this.isProduction = ENVIRONEMENT === 'prod'\r\n    this.env = ENVIRONEMENT\r\n  }\r\n\r\n  /*******\r\n  Public API\r\n  *******/\r\n\r\n  async init() {}\r\n\r\n  async sync() {\r\n    throw new Error('Not implemented')\r\n  }\r\n\r\n  async checkSyncNeeded() {\r\n    throw new Error('Not implemented')\r\n  }\r\n\r\n  async extract(incomingText) {\r\n    throw new Error('Not implemented')\r\n  }\r\n\r\n  async getCustomEntities() {\r\n    throw new Error('Not implemented')\r\n  }\r\n\r\n  /*******\r\n  Shared API\r\n  *******/\r\n\r\n  async getAvailableEntities() {\r\n    return [...(await this.getCustomEntities()), ...(await this._getProviderEntities())]\r\n  }\r\n\r\n  /*******\r\n  Private Methods\r\n  *******/\r\n\r\n  async _getProviderEntities() {\r\n    return _.toPairs(Entities)\r\n      .filter(p => p[1][this.entityKey])\r\n      .map(p => ({\r\n        name: p[0],\r\n        isFromProvider: true,\r\n        nameProvider: p[1][this.entityKey]\r\n      }))\r\n  }\r\n}\r\n\r\nexport const defaultExtractData = provider => ({\r\n  intent: {\r\n    name: 'None',\r\n    confidence: 0,\r\n    provider\r\n  },\r\n  intents: [],\r\n  entities: []\r\n})\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/providers/base.js","module.exports = require(\"bluebird\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bluebird\"\n// module id = 3\n// module chunks = 0","export default {\r\n  // Date & Time\r\n  '@native.date': { '@luis': 'datetimeV2', '@dialogflow': 'date', '@recast': 'datetime' },\r\n  '@native.date-period': { '@luis': 'datetimeV2', '@dialogflow': 'date-period', '@recast': 'interval' },\r\n  '@native.date-time': { '@luis': 'datetimeV2', '@dialogflow': 'date-time', '@recast': 'datetime' },\r\n  '@native.time': { '@luis': 'datetimeV2', '@dialogflow': 'time', '@recast': 'datetime' },\r\n  '@native.time-period': { '@luis': 'datetimeV2', '@dialogflow': 'time-period', '@recast': 'interval' },\r\n\r\n  // Numbers\r\n  '@native.cardinal': { '@dialogflow': 'cardinal', '@recast': 'cardinal' },\r\n  '@native.flight-number': { '@dialogflow': 'flight-number' },\r\n  '@native.number': { '@dialogflow': 'number', '@luis': 'number', '@recast': 'number' },\r\n  '@native.number-integer': { '@dialogflow': 'number-integer', '@recast': 'ordinal' },\r\n  '@native.number-sequence': { '@dialogflow': 'number-sequence' },\r\n  '@native.ordinal': { '@luis': 'ordinal', '@dialogflow': 'ordinal', '@recast': 'ordinal' },\r\n\r\n  // Amounts with Units\r\n  '@native.age': { '@dialogflow': 'age', '@luis': 'age' },\r\n  '@native.duration': { '@dialogflow': 'duration', '@recast': 'duration' },\r\n  '@native.percentage': { '@luis': 'percentage', '@dialogflow': 'percentage', '@recast': 'percent' },\r\n  '@native.set': { '@recast': 'set' },\r\n  '@native.temperature': { '@luis': 'temperature', '@dialogflow': 'temperature', '@recast': 'temperature' },\r\n  '@native.unit-area': { '@luis': 'dimension', '@dialogflow': 'unit-area' },\r\n  '@native.unit-currency': { '@luis': 'money', '@dialogflow': 'unit-currency', '@recast': 'money' },\r\n  '@native.unit-information': { '@dialogflow': 'unit-information' },\r\n  '@native.unit-length': { '@luis': 'dimension', '@dialogflow': 'unit-lenght', '@recast': 'distance' },\r\n  '@native.unit-speed': { '@dialogflow': 'unit-speed', '@recast': 'speed' },\r\n  '@native.unit-volume': { '@dialogflow': 'unit-volume', '@recast': 'volume' },\r\n  '@native.unit-weight': { '@dialogflow': 'unit-weight', '@recast': 'mass' },\r\n\r\n  // Unit Names\r\n  '@native.currency-name': { '@dialogflow': 'currency-name' },\r\n  '@native.unit-area-name': { '@dialogflow': 'unit-area-name' },\r\n  '@native.unit-information-name': { '@dialogflow': 'unit-information-name' },\r\n  '@native.unit-length-name': { '@dialogflow': 'unit-lenght-name' },\r\n  '@native.unit-speed-name': { '@dialogflow': 'unit-speed-name' },\r\n  '@native.unit-volume-name': { '@dialogflow': 'unit-volume-name' },\r\n  '@native.unit-weight-name': { '@dialogflow': 'unit-weight-name' },\r\n\r\n  // Geography\r\n  '@native.address': { '@dialogflow': 'address', '@recast': 'location' },\r\n  '@native.airport': { '@dialogflow': 'airport', '@recast': 'location' },\r\n  '@native.geo-capital': { '@dialogflow': 'geo-capital' },\r\n  '@native.geo-country': { '@dialogflow': 'geo-country', '@recast': 'location' },\r\n  '@native.geo-country-code': { '@dialogflow': 'geo-country-code' },\r\n  '@native.geo-city': { '@dialogflow': 'geo-city', '@recast': 'location' },\r\n  '@native.geo-city-gb': { '@dialogflow': 'geo-city-gb', '@recast': 'location' },\r\n  '@native.geo-city-us': { '@dialogflow': 'geo-city-us', '@recast': 'location' },\r\n  '@native.geo-state-us': { '@dialogflow': 'geo-state-us', '@recast': 'location' },\r\n  '@native.ip': { '@recast': 'ip' },\r\n  '@native.location': { '@dialogflow': 'location', '@recast': 'location' },\r\n  '@native.place-attraction-us': { '@dialogflow': 'place-attraction-us', '@recast': 'location' },\r\n  '@native.place-attraction-gb': { '@dialogflow': 'place-attraction-gb', '@recast': 'location' },\r\n  '@native.street-address': { '@dialogflow': 'street-address', '@recast': 'location' },\r\n  '@native.zip-code': { '@dialogflow': 'zip-code', '@recast': 'location' },\r\n\r\n  // Contacts\r\n  '@native.email': { '@luis': 'email', '@dialogflow': 'email', '@recast': 'email' },\r\n  '@native.phone-number': { '@luis': 'phonenumber', '@dialogflow': 'phone-number', '@recast': 'phone' },\r\n\r\n  // Person\r\n  '@native.given-name': { '@dialogflow': 'given-name' },\r\n  '@native.last-name': { '@dialogflow': 'last-name' },\r\n  '@native.name': { '@recast': 'person' },\r\n  '@native.nationality': { '@recast': 'nationality' },\r\n\r\n  // Music\r\n  '@native.music-artist': { '@dialogflow': 'music-artist' },\r\n  '@native.music-genre': { '@dialogflow': 'music-genre' },\r\n\r\n  // Others\r\n  '@native.color': { '@dialogflow': 'color', '@recast': 'color' },\r\n  '@native.emoji': { '@recast': 'emoji' },\r\n  '@native.job': { '@recast': 'job' },\r\n  '@native.language': { '@dialogflow': 'language', '@recast': 'language' },\r\n  '@native.organization': { '@recast': 'organization' },\r\n  '@native.pronoun': { '@recast': 'pronoun' },\r\n  '@native.sort': { '@recast': 'sort' },\r\n  '@native.url': { '@luis': 'url', '@dialogflow': 'url', '@recast': 'url' },\r\n\r\n  // Generic\r\n  '@native.any': { '@dialogflow': 'any', '@rasa': 'any' }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/providers/entities.js","module.exports = require(\"axios\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"axios\"\n// module id = 5\n// module chunks = 0","import retry from 'bluebird-retry'\r\nimport moment from 'moment'\r\n\r\nimport Storage from './storage'\r\nimport Parser from './parser'\r\n\r\nimport DialogflowProvider from './providers/dialogflow'\r\nimport LuisProvider from './providers/luis'\r\nimport RasaProvider from './providers/rasa'\r\nimport RecastProvider from './providers/recast'\r\nimport NativeProvider from './providers/native'\r\n\r\nlet storage\r\nlet provider\r\n\r\nmodule.exports = {\r\n  config: {\r\n    intentsDir: { type: 'string', required: true, default: './intents', env: 'NLU_INTENTS_DIR' },\r\n    entitiesDir: { type: 'string', required: true, default: './entities', env: 'NLU_ENTITIES_DIR' },\r\n\r\n    // Provider config\r\n    provider: { type: 'string', required: true, default: 'native', env: 'NLU_PROVIDER' },\r\n\r\n    // DIALOGFLOW-specific config\r\n    googleProjectId: { type: 'string', required: false, default: '', env: 'NLU_GOOGLE_PROJECT_ID' },\r\n\r\n    // LUIS-specific config\r\n    luisAppId: { type: 'string', required: false, default: '', env: 'NLU_LUIS_APP_ID' },\r\n    luisProgrammaticKey: { type: 'string', required: false, default: '', env: 'NLU_LUIS_PROGRAMMATIC_KEY' },\r\n    luisAppSecret: { type: 'string', required: false, default: '', env: 'NLU_LUIS_APP_SECRET' },\r\n    luisAppRegion: { type: 'string', required: false, default: 'westus', env: 'NLU_LUIS_APP_REGION' },\r\n\r\n    // RASA-specific config\r\n    rasaEndpoint: { type: 'string', required: false, default: 'http://localhost:5000', env: 'NLU_RASA_URL' },\r\n    rasaToken: { type: 'string', required: false, default: '', env: 'NLU_RASA_TOKEN' },\r\n    rasaProject: { type: 'string', required: false, default: 'botpress', env: 'NLU_RASA_PROJECT' },\r\n\r\n    // RECAST-specific config\r\n    recastToken: { type: 'string', required: false, default: '', env: 'NLU_RECAST_TOKEN' },\r\n    recastUserSlug: { type: 'string', required: false, default: '', env: 'NLU_RECAST_USER_SLUG' },\r\n    recastBotSlug: { type: 'string', required: false, default: '', env: 'NLU_RECAST_BOT_SLUG' },\r\n\r\n    // Debug mode will print NLU information to the console for debugging purposes\r\n    debugModeEnabled: { type: 'bool', required: true, default: false, env: 'NLU_DEBUG_ENABLED' },\r\n\r\n    // The minimum confidence required (in %) for an intent to match\r\n    // Set to '0' to always match\r\n    minimumConfidence: { type: 'string', required: false, default: '0.3', env: 'NLU_MIN_CONFIDENCE' },\r\n\r\n    // The maximum confidence after which it is considered a statistical error\r\n    // Mostly irrelevant except for NLU=native\r\n    maximumConfidence: { type: 'string', required: false, default: '1000', env: 'NLU_MAX_CONFIDENCE' },\r\n\r\n    // The minimum difference between scores required before we apply a distribution fixes\r\n    nativeAdjustementThreshold: { type: 'string', required: false, default: '0.25', env: 'NLU_NATIVE_ADJ_THRESHOLD' },\r\n    // The maximum number of requests per hour\r\n    // Useful to make sure you don't overuse your budget on paid NLU-services (like LUIS)\r\n    maximumRequestsPerHour: { type: 'string', required: false, default: '1000', env: 'NLU_MAX_REQUESTS_PER_HOUR' }\r\n  },\r\n\r\n  init: async function(bp, configurator) {\r\n    const config = await configurator.loadAll()\r\n    storage = new Storage({ bp, config })\r\n    await storage.initializeGhost()\r\n\r\n    const Provider = {\r\n      dialogflow: DialogflowProvider,\r\n      luis: LuisProvider,\r\n      rasa: RasaProvider,\r\n      recast: RecastProvider,\r\n      native: NativeProvider\r\n    }[config.provider.toLowerCase()]\r\n\r\n    if (!Provider) {\r\n      throw new Error(`Unknown NLU provider \"${config.provider}\"`)\r\n    }\r\n\r\n    let MIN_CONFIDENCE = parseFloat(config.minimumConfidence)\r\n\r\n    if (isNaN(MIN_CONFIDENCE) || MIN_CONFIDENCE < 0 || MIN_CONFIDENCE > 1) {\r\n      MIN_CONFIDENCE = 0\r\n    }\r\n\r\n    let MAX_CONFIDENCE = parseFloat(config.maximumConfidence)\r\n\r\n    if (isNaN(MAX_CONFIDENCE) || MAX_CONFIDENCE < 0) {\r\n      MAX_CONFIDENCE = 10000\r\n    }\r\n\r\n    provider = new Provider({\r\n      logger: bp.logger,\r\n      storage,\r\n      parser: new Parser(),\r\n      kvs: bp.kvs,\r\n      config\r\n    })\r\n    await provider.init()\r\n\r\n    const retryPolicy = {\r\n      interval: 100,\r\n      max_interval: 500,\r\n      timeout: 5000,\r\n      max_tries: 3\r\n    }\r\n\r\n    async function processEvent(event) {\r\n\r\n      if (['session_reset', 'bp_dialog_timeout', 'visit', 'read', 'delivery'].includes(event.type)) {\r\n        return\r\n      }\r\n\r\n      const previous = JSON.parse((await bp.kvs.get('nlu/requestsLimit')) || '{}')\r\n      const hour = moment().startOf('hour')\r\n      const requestsCount = hour.isSame(previous.hour) ? previous.requestsCount : 0\r\n\r\n      await bp.kvs.set('nlu/requestsLimit', JSON.stringify({ hour, requestsCount: requestsCount + 1 }))\r\n\r\n      const maximumRequestsPerHour = parseFloat(config.maximumRequestsPerHour)\r\n      if (requestsCount > maximumRequestsPerHour) {\r\n        throw new Error(\r\n          `[NLU] Requests limit per hour exceeded: ${maximumRequestsPerHour} allowed ` +\r\n            `while getting ${requestsCount}. You can set higher value to NLU_MAX_REQUESTS_PER_HOUR.`\r\n        )\r\n      }\r\n\r\n      let eventIntent = {}\r\n      let eventIntents = []\r\n\r\n      try {\r\n        if (config.debugModeEnabled) {\r\n          bp.logger.info('[NLU Extraction] ' + event.text, event.raw)\r\n        }\r\n\r\n        const metadata = await retry(() => provider.extract(event), retryPolicy)\r\n\r\n        if (metadata) {\r\n          Object.assign(event, { nlu: metadata })\r\n          eventIntent = metadata.intent\r\n          eventIntents = metadata.intents\r\n        }\r\n      } catch (err) {\r\n        bp.logger.warn('[NLU] Error extracting metadata for incoming text: ' + err.message)\r\n      }\r\n\r\n      const intentConfidentEnough = () => {\r\n        const confidence = eventIntent.confidence != null ? eventIntent.confidence : 1\r\n        return confidence >= MIN_CONFIDENCE && confidence <= MAX_CONFIDENCE\r\n      }\r\n\r\n      if (event.nlu) {\r\n        Object.assign(event.nlu.intent, {\r\n          intentConfidentEnough,\r\n          is: intentName => {\r\n            intentName = (intentName || '').toLowerCase()\r\n            return intentConfidentEnough() && (eventIntent.name || '').toLowerCase() === intentName\r\n          },\r\n          startsWith: prefix => {\r\n            prefix = (prefix || '').toLowerCase()\r\n            return intentConfidentEnough() && (eventIntent.name || '').toLowerCase().startsWith(prefix)\r\n          }\r\n        })\r\n        Object.assign(event.nlu.intents, {\r\n          has: intentName => {\r\n            intentName = (intentName || '').toLowerCase()\r\n            return !!eventIntents.find(intent => (intent.name || '').toLowerCase() === intentName)\r\n          }\r\n        })\r\n      }\r\n    }\r\n\r\n    bp.nlu = {\r\n      processEvent,\r\n      provider,\r\n      storage\r\n    }\r\n\r\n    bp.middlewares.register({\r\n      name: 'nlu.incoming',\r\n      module: 'botpress-nlu',\r\n      type: 'incoming',\r\n      handler: async (event, next) => {\r\n        await processEvent(event)\r\n        next()\r\n      },\r\n      order: 10,\r\n      description:\r\n        'Process natural language in the form of text. Structured data with an action and parameters for that action is injected in the incoming message event.'\r\n    })\r\n  },\r\n\r\n  ready: async function(bp) {\r\n    const router = bp.getRouter('botpress-nlu')\r\n\r\n    router.delete('/intents/:intent', async (req, res) => {\r\n      await storage.deleteIntent(req.params.intent)\r\n      res.sendStatus(200)\r\n    })\r\n\r\n    router.post('/intents/:intent', async (req, res) => {\r\n      await storage.saveIntent(req.params.intent, req.body)\r\n      res.sendStatus(200)\r\n    })\r\n\r\n    router.get('/intents', async (req, res) => {\r\n      res.send(await storage.getIntents())\r\n    })\r\n\r\n    router.get('/intents/:intent', async (req, res) => {\r\n      res.send(await storage.getIntent(req.params.intent))\r\n    })\r\n\r\n    router.get('/entities', async (req, res) => {\r\n      res.send((await provider.getAvailableEntities()).map(x => x.name))\r\n    })\r\n\r\n    router.get('/sync/check', async (req, res) => {\r\n      res.send(await provider.checkSyncNeeded())\r\n    })\r\n\r\n    router.get('/sync', async (req, res) => {\r\n      try {\r\n        bp.events.emit('toast.nlu-sync', { text: 'NLU Sync In Progress', type: 'info', time: 120000 })\r\n\r\n        await provider.sync()\r\n\r\n        bp.events.emit('toast.nlu-sync', { text: 'NLU Sync Success', type: 'success' })\r\n        res.sendStatus(200)\r\n      } catch (e) {\r\n        bp.events.emit('toast.nlu-sync', { text: `NLU Sync Error: ${e.name} : ${e.message}`, type: 'error' })\r\n        res.status(500).send(`${e.name} : ${e.message}`)\r\n      }\r\n    })\r\n  }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","module.exports = require(\"bluebird-retry\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bluebird-retry\"\n// module id = 8\n// module chunks = 0","module.exports = require(\"moment\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"moment\"\n// module id = 9\n// module chunks = 0","import mkdirp from 'mkdirp'\r\nimport path from 'path'\r\nimport _ from 'lodash'\r\nimport Promise from 'bluebird'\r\n\r\nconst formatFilename = name =>\r\n  name\r\n    .toLowerCase()\r\n    .replace(/[^a-z0-9-_.]/gi, '_')\r\n    .replace('.entities.json', '')\r\n    .replace('.entity.json', '')\r\n    .replace('.json', '')\r\n    .replace('.utterances.txt', '')\r\n\r\nexport default class Storage {\r\n  constructor({ bp, config, provider }) {\r\n    this.ghost = bp.ghostManager\r\n    this.intentsDir = config.intentsDir\r\n    this.entitiesDir = config.entitiesDir\r\n    this.projectDir = bp.projectLocation\r\n    this.provider = provider\r\n  }\r\n\r\n  async initializeGhost() {\r\n    mkdirp.sync(path.resolve(this.projectDir, this.intentsDir))\r\n    mkdirp.sync(path.resolve(this.projectDir, this.entitiesDir))\r\n\r\n    await this.ghost.addRootFolder(this.intentsDir, { filesGlob: '**/*.*' })\r\n    await this.ghost.addRootFolder(this.entitiesDir, { filesGlob: '**/*.entity.json' })\r\n  }\r\n\r\n  async saveIntent(intent, content) {\r\n    intent = formatFilename(intent)\r\n\r\n    if (intent.length < 1) {\r\n      throw new Error('Invalid intent name, expected at least one character')\r\n    }\r\n\r\n    const utterancesFile = `${intent}.utterances.txt`\r\n    const propertiesFile = `${intent}.json`\r\n\r\n    const utterances = content.utterances.join('\\r\\n') // \\n To support windows as well\r\n\r\n    await this.ghost.upsertFile(this.intentsDir, utterancesFile, utterances)\r\n    await this.ghost.upsertFile(\r\n      this.intentsDir,\r\n      propertiesFile,\r\n      JSON.stringify({\r\n        entities: content.entities\r\n      })\r\n    )\r\n  }\r\n\r\n  async deleteIntent(intent) {\r\n    intent = formatFilename(intent)\r\n\r\n    if (intent.length < 1) {\r\n      throw new Error('Invalid intent name, expected at least one character')\r\n    }\r\n\r\n    const utterancesFile = `${intent}.utterances.txt`\r\n    const propertiesFile = `${intent}.json`\r\n\r\n    try {\r\n      await this.ghost.deleteFile(this.intentsDir, utterancesFile)\r\n    } catch (e) {\r\n      if (e.code !== 'ENOENT' && !e.message.includes(\"couldn't find it\")) {\r\n        throw e\r\n      }\r\n    }\r\n\r\n    try {\r\n      await this.ghost.deleteFile(this.intentsDir, propertiesFile)\r\n    } catch (e) {\r\n      if (e.code !== 'ENOENT' && !e.message.includes(\"couldn't find it\")) {\r\n        throw e\r\n      }\r\n    }\r\n  }\r\n\r\n  async getIntents() {\r\n    const intents = await this.ghost.directoryListing(this.intentsDir, '.json')\r\n    return Promise.mapSeries(intents, intent => this.getIntent(intent))\r\n  }\r\n\r\n  async getIntent(intent) {\r\n    intent = formatFilename(intent)\r\n\r\n    if (intent.length < 1) {\r\n      throw new Error('Invalid intent name, expected at least one character')\r\n    }\r\n\r\n    const filename = `${intent}.json`\r\n\r\n    const propertiesContent = await this.ghost.readFile(this.intentsDir, filename)\r\n    const utterancesContent = await this.ghost.readFile(this.intentsDir, filename.replace('.json', '.utterances.txt'))\r\n\r\n    const utterances = _.split(utterancesContent, /\\r|\\r\\n|\\n/i).filter(x => x.length)\r\n    const properties = JSON.parse(propertiesContent)\r\n\r\n    return {\r\n      name: intent,\r\n      filename: filename,\r\n      utterances: utterances,\r\n      ...properties\r\n    }\r\n  }\r\n\r\n  async getCustomEntities() {\r\n    const entities = await this.ghost.directoryListing(this.entitiesDir, '.json')\r\n\r\n    return Promise.mapSeries(entities, entity => this.getCustomEntity(entity))\r\n  }\r\n\r\n  async getCustomEntity(entity) {\r\n    entity = formatFilename(entity)\r\n\r\n    if (entity.length < 1) {\r\n      throw new Error('Invalid entity name, expected at least one character')\r\n    }\r\n\r\n    const filename = `${entity}.entity.json`\r\n\r\n    const definitionContent = await this.ghost.readFile(this.entitiesDir, filename)\r\n    const definition = JSON.parse(definitionContent)\r\n\r\n    return {\r\n      name: entity,\r\n      definition: definition\r\n    }\r\n  }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/storage.js","module.exports = require(\"mkdirp\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"mkdirp\"\n// module id = 11\n// module chunks = 0","module.exports = require(\"path\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"path\"\n// module id = 12\n// module chunks = 0","import _ from 'lodash'\r\n\r\nexport default class Parser {\r\n  constructor() {}\r\n\r\n  extractLabelsFromCanonical(canonicalUtterance, intentEntities) {\r\n    const labels = []\r\n    let plainText = ''\r\n\r\n    const regex = /\\[(.+?)]\\((.+?)\\)/g\r\n    let m\r\n    let i = 0\r\n\r\n    do {\r\n      m = regex.exec(canonicalUtterance)\r\n      if (m) {\r\n        plainText += canonicalUtterance.substr(i, m.index - i)\r\n        i = m.index + m[0].length\r\n        plainText += m[1]\r\n        labels.push({\r\n          start: plainText.length - m[1].length,\r\n          end: plainText.length - 1,\r\n          entityName: m[2],\r\n          type: _.get(_.find(intentEntities, { name: m[2] }), 'type')\r\n        })\r\n      }\r\n    } while (m)\r\n\r\n    plainText += canonicalUtterance.substr(i, canonicalUtterance.length - i)\r\n\r\n    return {\r\n      text: plainText,\r\n      labels: labels\r\n    }\r\n  }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/parser.js","import _ from 'lodash'\r\nimport crypto from 'crypto'\r\n\r\nimport Provider from './base'\r\n\r\nexport default class DialogflowProvider extends Provider {\r\n  constructor(config) {\r\n    super({\r\n      ...config,\r\n      name: 'dialogflow',\r\n      entityKey: '@dialogflow'\r\n    })\r\n\r\n    this.projectId = this.config.googleProjectId\r\n\r\n    // TODO: get rid of eval once we drop webpack for node-part (needed to overcome webpack compilation)\r\n    const dialogflow = require('dialogflow') // eslint-disable-line no-eval\r\n\r\n    this.agentClient = new dialogflow.AgentsClient()\r\n    this.sessionClient = new dialogflow.SessionsClient()\r\n    this.contextClient = new dialogflow.ContextsClient()\r\n  }\r\n\r\n  _getSessionId(event) {\r\n    let shortUserId = _.get(event, 'user.id') || ''\r\n    if (shortUserId.length > 36) {\r\n      shortUserId = crypto\r\n        .createHash('md5')\r\n        .update(shortUserId)\r\n        .digest('hex')\r\n    }\r\n    return shortUserId\r\n  }\r\n\r\n  _resolveEntity(field) {\r\n    const entity = field[field.kind]\r\n\r\n    if (field.kind === 'stringValue' || field.kind === 'numberValue') {\r\n      return entity\r\n    } else if (field.kind === 'listValue') {\r\n      return entity.values.map(v => this._resolveEntity(v))\r\n    } else if (field.kind === 'structValue') {\r\n      return _.mapValues(entity.fields, f => this._resolveEntity(f))\r\n    } else {\r\n      throw new Error('Not supported')\r\n    }\r\n  }\r\n\r\n  /*******\r\n  Public API\r\n  *******/\r\n\r\n  async init() {\r\n    const [agent] = await this.agentClient.getAgent({\r\n      parent: this.agentClient.projectPath(this.projectId)\r\n    })\r\n    this.agent = agent\r\n  }\r\n\r\n  async sync() {\r\n    throw new Error('Not implemented')\r\n  }\r\n\r\n  async checkSyncNeeded() {\r\n    return false // Not implemented yet\r\n  }\r\n\r\n  async extract(event) {\r\n\r\n    const request = {\r\n      session: this.sessionClient.sessionPath(this.projectId, this._getSessionId(event)),\r\n      queryInput: {\r\n        text: {\r\n          //TODO Find a way to pass node and flow as context?\r\n          text: event.text,\r\n          languageCode: this.agent.defaultLanguageCode\r\n        }\r\n\t  },\r\n\t  queryParams: {\r\n\t\tsentimentAnalysisRequestConfig: {\r\n\t\t  analyzeQueryTextSentiment: true,\r\n\t\t},\r\n\t  }\r\n    }\r\n    const detection = await this.sessionClient.detectIntent(request)\r\n    const {\r\n      queryResult\r\n    } = detection[0]\r\n\r\n    const isSmallTalk = queryResult.action.startsWith('smalltalk')\r\n\r\n    const intent = {\r\n      name: isSmallTalk ? queryResult.action : queryResult.intent && queryResult.intent.displayName,\r\n      isSmallTalk,\r\n      confidence: queryResult.intentDetectionConfidence,\r\n      provider: 'dialogflow'\r\n    }\r\n    const entities = _.map(queryResult.parameters.fields, (v, k) => ({\r\n      name: k,\r\n      value: this._resolveEntity(v)\r\n    }))\r\n\r\n    const context = {\r\n      add: (event, name, lifespan) => {\r\n\r\n        const sessionPath = this.contextClient.sessionPath(this.projectId, this._getSessionId(event));\r\n\r\n        const contextPath = this.contextClient.contextPath(\r\n          this.projectId,\r\n          this._getSessionId(event),\r\n          name\r\n        );\r\n\r\n        const createContextRequest = {\r\n          parent: sessionPath,\r\n          context: {\r\n            name: contextPath,\r\n            lifespanCount: lifespan\r\n          }\r\n        };\r\n\r\n        return this.contextClient.createContext(createContextRequest);\r\n      }\r\n    }\r\n\r\n    return {\r\n      intent,\r\n      context,\r\n      intents: [intent],\r\n      original: detection,\r\n      entities: entities.map(entity => ({\r\n        name: entity.name, // usually the entity name, but can be modified\r\n        type: entity.name, // when parameter name modified dialogflow doesn't give the original entity name\r\n        value: entity.value,\r\n        original: null,\r\n        confidence: null,\r\n        position: null,\r\n        provider: 'dialogflow'\r\n      }))\r\n    }\r\n  }\r\n\r\n  async getCustomEntities() {\r\n    return [] // Not implemented yet\r\n  }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/providers/dialogflow.js","module.exports = require(\"dialogflow\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"dialogflow\"\n// module id = 15\n// module chunks = 0","import axios from 'axios'\r\nimport _ from 'lodash'\r\nimport crypto from 'crypto'\r\nimport Promise from 'bluebird'\r\n\r\nimport Provider, { defaultExtractData } from './base'\r\nimport Entities from './entities'\r\n\r\nconst LUIS_APP_VERSION = '1.0' // Static, we're not using this as everything is source-controlled in your bot\r\nconst LUIS_HASH_KVS_KEY = 'nlu/luis/updateMetadata'\r\n\r\nexport default class LuisProvider extends Provider {\r\n  constructor(config) {\r\n    super({ ...config, name: 'luis', entityKey: '@luis' })\r\n\r\n    this.appId = this.config.luisAppId\r\n    this.programmaticKey = this.config.luisProgrammaticKey\r\n    this.appSecret = this.config.luisAppSecret\r\n    this.appRegion = this.config.luisAppRegion\r\n  }\r\n\r\n  async init() {}\r\n\r\n  async getRemoteVersion() {\r\n    try {\r\n      const res = await axios.get(\r\n        `https://${this.appRegion}.api.cognitive.microsoft.com/luis/api/v2.0/apps/${this.appId}/versions`,\r\n        {\r\n          headers: {\r\n            'Ocp-Apim-Subscription-Key': this.programmaticKey\r\n          }\r\n        }\r\n      )\r\n\r\n      return _.find(res.data, { version: LUIS_APP_VERSION })\r\n    } catch (err) {\r\n      this.logger.debug('[NLU::Luis] Could not fetch app versions')\r\n      return []\r\n    }\r\n  }\r\n\r\n  async deleteVersion() {\r\n    try {\r\n      const del = await axios.delete(\r\n        `https://${this.appRegion}.api.cognitive.microsoft.com/luis/api/v2.0/apps/${this\r\n          .appId}/versions/${LUIS_APP_VERSION}/`,\r\n        {\r\n          headers: {\r\n            'Ocp-Apim-Subscription-Key': this.programmaticKey\r\n          }\r\n        }\r\n      )\r\n\r\n      if (del.statusCode === 200) {\r\n        this.logger.debug('[NLU::Luis] Removed old version of the model')\r\n      }\r\n    } catch (err) {\r\n      this.logger.debug('[NLU::Luis] Could not remove old version of the model')\r\n    }\r\n  }\r\n\r\n  async getAppInfo() {\r\n    try {\r\n      const response = await axios.get(\r\n        `https://${this.appRegion}.api.cognitive.microsoft.com/luis/api/v2.0/apps/${this.appId}`,\r\n        {\r\n          headers: {\r\n            'Ocp-Apim-Subscription-Key': this.programmaticKey\r\n          }\r\n        }\r\n      )\r\n      return response.data\r\n    } catch (err) {\r\n      throw new Error('[NLU::Luis] Could not find app ' + this.appId)\r\n    }\r\n  }\r\n\r\n  async isInSync(localIntents, remoteVersion) {\r\n    const intentsHash = crypto\r\n      .createHash('md5')\r\n      .update(JSON.stringify(localIntents))\r\n      .digest('hex')\r\n\r\n    const metadata = await this.kvs.get(LUIS_HASH_KVS_KEY)\r\n\r\n    return metadata && metadata.hash === intentsHash && metadata.time === remoteVersion.lastModifiedDateTime\r\n  }\r\n\r\n  async checkSyncNeeded() {\r\n    const intents = await this.storage.getIntents()\r\n    const currentVersion = await this.getRemoteVersion()\r\n    return !await this.isInSync(intents, currentVersion)\r\n  }\r\n\r\n  async onSyncSuccess(localIntents, remoteVersion) {\r\n    const intentsHash = crypto\r\n      .createHash('md5')\r\n      .update(JSON.stringify(localIntents))\r\n      .digest('hex')\r\n\r\n    await this.kvs.set(LUIS_HASH_KVS_KEY, {\r\n      hash: intentsHash,\r\n      time: remoteVersion.lastModifiedDateTime\r\n    })\r\n  }\r\n\r\n  async getCustomEntities() {\r\n    const { simples, composites, lists } = await this.getCustomLuisEntities()\r\n\r\n    const mapToType = (list, type) =>\r\n      list.map(x => ({\r\n        name: '@custom.' + x.name,\r\n        isFromProvider: false,\r\n        nameProvider: x.name,\r\n        providerType: type,\r\n        definition: x\r\n      }))\r\n\r\n    return [\r\n      ...mapToType(simples, 'entities'),\r\n      ...mapToType(composites, 'composites'),\r\n      ...mapToType(lists, 'closedLists')\r\n    ]\r\n  }\r\n\r\n  async getCustomLuisEntities() {\r\n    const entities = await this.storage.getCustomEntities()\r\n\r\n    const simplesDef = _.find(entities, e => e.name.toLowerCase() === 'luis_entities')\r\n    const compositesDef = _.find(entities, e => e.name.toLowerCase() === 'luis_composites')\r\n    const listsDef = _.find(entities, e => e.name.toLowerCase() === 'luis_closedlists')\r\n\r\n    const simples = (simplesDef && simplesDef.definition) || []\r\n    const composites = (compositesDef && compositesDef.definition) || []\r\n    const lists = (listsDef && listsDef.definition) || []\r\n\r\n    return { simples, composites, lists }\r\n  }\r\n\r\n  validateCredentials() {\r\n    const missingPattern = name =>\r\n      '[NLU::LUIS] \"' +\r\n      name +\r\n      '\" is missing from the configuration, please have a look at botpress-nlu ' +\r\n      'documentation to learn how to setup the credentials.'\r\n\r\n    if (_.isEmpty(this.appId)) {\r\n      throw new Error(missingPattern('Application Id'))\r\n    }\r\n\r\n    if (_.isEmpty(this.programmaticKey)) {\r\n      throw new Error(missingPattern('Programmatic Key'))\r\n    }\r\n\r\n    if (_.isEmpty(this.appId)) {\r\n      throw new Error(missingPattern('Application Secret'))\r\n    }\r\n\r\n    if (_.isEmpty(this.appId)) {\r\n      throw new Error(missingPattern('Application Region'))\r\n    }\r\n  }\r\n\r\n  async sync() {\r\n    if (this.syncingSince && new Date() - this.syncingSince <= 10 * 60 * 1000) {\r\n      this.logger.warn('[NLU::Luis] Tried to sync while syncing in progress')\r\n      return\r\n    }\r\n\r\n    this.syncingSince = new Date()\r\n\r\n    this.validateCredentials()\r\n\r\n    const intents = await this.storage.getIntents()\r\n    let currentVersion = await this.getRemoteVersion()\r\n\r\n    if (await this.isInSync(intents, currentVersion)) {\r\n      this.logger.debug('[NLU::Luis] Model is up to date')\r\n      return\r\n    } else {\r\n      this.logger.debug('[NLU::Luis] The model needs to be updated')\r\n    }\r\n\r\n    if (currentVersion) {\r\n      this.logger.debug('[NLU::Luis] Deleting old version of the model')\r\n      await this.deleteVersion()\r\n    }\r\n\r\n    const utterances = []\r\n\r\n    const builtinEntities = []\r\n    const simpleEntities = []\r\n    const compositeEntities = []\r\n    const listEntities = []\r\n\r\n    const availableEntities = await this.getAvailableEntities()\r\n\r\n    intents.forEach(intent => {\r\n      intent.utterances.forEach(utterance => {\r\n        const extracted = this.parser.extractLabelsFromCanonical(utterance, intent.entities)\r\n        if (!extracted.text || !extracted.text.trim()) {\r\n          return\r\n        }\r\n\r\n        const entities = []\r\n\r\n        extracted.labels.forEach(label => {\r\n          const entity = _.find(availableEntities, { name: label.type })\r\n\r\n          if (!entity) {\r\n            throw new Error('[NLU::Luis] Unknown entity: ' + label.type)\r\n          }\r\n\r\n          if (entity.isFromProvider && builtinEntities.indexOf(entity.nameProvider) === -1) {\r\n            builtinEntities.push(entity.nameProvider)\r\n          } else if (entity.providerType === 'entities' && !_.find(simpleEntities, { name: entity.nameProvider })) {\r\n            simpleEntities.push(entity.definition)\r\n          } else if (\r\n            entity.providerType === 'composites' &&\r\n            !_.find(compositeEntities, { name: entity.nameProvider })\r\n          ) {\r\n            compositeEntities.push(entity.definition)\r\n          } else if (entity.providerType === 'closedLists' && !_.find(listEntities, { name: entity.nameProvider })) {\r\n            listEntities.push(entity.definition)\r\n          }\r\n\r\n          entities.push({\r\n            entity: entity.nameProvider,\r\n            startPos: label.start,\r\n            endPos: label.end\r\n          })\r\n        })\r\n\r\n        utterances.push({\r\n          text: extracted.text,\r\n          intent: intent.name,\r\n          entities: entities\r\n        })\r\n      })\r\n    })\r\n\r\n    const appInfo = await this.getAppInfo()\r\n\r\n    const body = {\r\n      luis_schema_version: '2.1.0',\r\n      versionId: LUIS_APP_VERSION,\r\n      name: appInfo.name,\r\n      desc: appInfo.description,\r\n      culture: appInfo.culture,\r\n      intents: intents.map(i => ({ name: i.name })),\r\n      entities: simpleEntities,\r\n      composites: compositeEntities,\r\n      closedLists: listEntities,\r\n      bing_entities: builtinEntities,\r\n      model_features: [],\r\n      regex_features: [],\r\n      utterances: utterances\r\n    }\r\n\r\n    try {\r\n      const result = await axios.post(\r\n        `https://${this.appRegion}.api.cognitive.microsoft.com/luis/api/v2.0/apps/${this\r\n          .appId}/versions/import?versionId=${LUIS_APP_VERSION}`,\r\n        body,\r\n        {\r\n          headers: {\r\n            'Ocp-Apim-Subscription-Key': this.programmaticKey\r\n          }\r\n        }\r\n      )\r\n\r\n      await this.train()\r\n\r\n      currentVersion = await this.getRemoteVersion()\r\n      await this.onSyncSuccess(intents, currentVersion)\r\n\r\n      this.logger.info('[NLU::Luis] Synced model [' + result.data + ']')\r\n    } catch (err) {\r\n      const detailedError = _.get(err, 'response.data.error.message') || (err && err.message) || err\r\n      this.logger.error('[NLU::Luis] Could not sync the model. Error = ' + detailedError)\r\n    }\r\n    this.syncingSince = null\r\n  }\r\n\r\n  async train() {\r\n    let res = await axios.post(\r\n      `https://${this.appRegion}.api.cognitive.microsoft.com/luis/api/v2.0/apps/${this\r\n        .appId}/versions/${LUIS_APP_VERSION}/train`,\r\n      {},\r\n      {\r\n        headers: {\r\n          'Ocp-Apim-Subscription-Key': this.programmaticKey\r\n        }\r\n      }\r\n    )\r\n\r\n    if (res.data.status !== 'Queued') {\r\n      throw new Error('Expected training to be Queued but was: ' + res.data.status)\r\n    }\r\n\r\n    while (true) {\r\n      res = await axios.get(\r\n        `https://${this.appRegion}.api.cognitive.microsoft.com/luis/api/v2.0/apps/${this\r\n          .appId}/versions/${LUIS_APP_VERSION}/train`,\r\n        {\r\n          headers: {\r\n            'Ocp-Apim-Subscription-Key': this.programmaticKey\r\n          }\r\n        }\r\n      )\r\n\r\n      const models = res.data\r\n\r\n      const percent = _.filter(models, m => m.details.status === 'Success').length / models.length\r\n\r\n      const error = _.find(models, m => m.details.status === 'Fail')\r\n\r\n      if (error) {\r\n        throw new Error(\r\n          `[NLU::Luis] Error training model \"${error.modelId}\", reason is \"${error.details.failureReason}\"`\r\n        )\r\n      }\r\n\r\n      if (percent >= 1) {\r\n        this.logger.debug('[NLU::Luis] Model trained (100%)')\r\n        break\r\n      } else {\r\n        this.logger.debug('[NLU::Luis] Training... ' + percent.toFixed(2) * 100 + '%')\r\n      }\r\n\r\n      await Promise.delay(1000)\r\n    }\r\n\r\n    await Promise.delay(1000)\r\n\r\n    await axios.post(\r\n      `https://${this.appRegion}.api.cognitive.microsoft.com/luis/api/v2.0/apps/${this.appId}/publish`,\r\n      {\r\n        versionId: LUIS_APP_VERSION,\r\n        isStaging: !this.isProduction,\r\n        region: this.appRegion\r\n      },\r\n      {\r\n        headers: {\r\n          'Ocp-Apim-Subscription-Key': this.programmaticKey\r\n        }\r\n      }\r\n    )\r\n  }\r\n\r\n  async extract(incomingEvent) {\r\n    try {\r\n      this.validateCredentials()\r\n    } catch (err) {\r\n      this.logger.warn(\r\n        '[NLU::Luis] Did not extract NLU metadata for incoming text because Luis is not configured properly.'\r\n      )\r\n\r\n      return defaultExtractData('luis')\r\n    }\r\n\r\n    const res = await axios.get(`https://${this.appRegion}.api.cognitive.microsoft.com/luis/v2.0/apps/${this.appId}`, {\r\n      params: {\r\n        q: incomingEvent.text,\r\n        verbose: true,\r\n        spellCheck: false,\r\n        staging: !this.isProduction\r\n      },\r\n      headers: {\r\n        'Ocp-Apim-Subscription-Key': this.appSecret\r\n      }\r\n    })\r\n\r\n    const intentName = _.get(res, 'data.topScoringIntent.intent') || 'None'\r\n    const confidence = _.get(res, 'data.topScoringIntent.score') || 0\r\n    const intents = _.get(res, 'data.intents') || []\r\n    const entities = _.get(res, 'data.entities') || []\r\n\r\n    return {\r\n      intent: {\r\n        name: intentName,\r\n        confidence: parseFloat(confidence),\r\n        provider: 'luis'\r\n      },\r\n      intents: intents.map(intent => ({\r\n        name: intent.intent,\r\n        confidence: parseFloat(intent.score),\r\n        provider: 'luis'\r\n      })),\r\n      entities: entities.map(entity => ({\r\n        name: null,\r\n        type: entity.type,\r\n        value:\r\n          _.get(entity, 'resolution.values.0.value') ||\r\n          _.get(entity, 'resolution.value') ||\r\n          _.get(entity, 'resolution.values.0') ||\r\n          entity.entity,\r\n        unit: _.get(entity, 'resolution.unit'),\r\n        original: entity.entity,\r\n        confidence: null,\r\n        position: entity.startIndex,\r\n        provider: 'luis'\r\n      }))\r\n    }\r\n  }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/providers/luis.js","import axios from 'axios'\r\nimport _ from 'lodash'\r\nimport crypto from 'crypto'\r\nimport Promise from 'bluebird'\r\nimport ms from 'ms'\r\n\r\nimport Provider, { defaultExtractData } from './base'\r\nimport Entities from './entities'\r\n\r\nconst RASA_HASH_KVS_KEY = 'nlu/rasa/updateMetadata'\r\n\r\nexport default class RasaProvider extends Provider {\r\n  constructor(config) {\r\n    super({ ...config, name: 'rasa', entityKey: '@rasa' })\r\n\r\n    this.endpoint = this.config.rasaEndpoint\r\n    this.token = this.config.rasaToken\r\n    this.project = this.config.rasaProject\r\n\r\n    this.client = axios.create({\r\n      baseURL: this.endpoint,\r\n      params: this.token && this.token.length ? { token: this.token } : {}\r\n    })\r\n  }\r\n\r\n  async init() {}\r\n\r\n  async checkSyncNeeded() {\r\n    const intents = await this.storage.getIntents()\r\n    const remoteVersions = await this._getRemoteVersions()\r\n    return !await this._isInSync(intents, remoteVersions)\r\n  }\r\n\r\n  _getProjectName() {\r\n    const scope = 'all'\r\n    return `${this.env}__${this.project}__${scope}`\r\n  }\r\n\r\n  async _getRemoteVersions() {\r\n    try {\r\n      const projectName = this._getProjectName()\r\n      const res = await this.client.get('/status')\r\n      const versions = _.get(res, 'data.available_projects.' + projectName + '.available_models') || []\r\n      return versions\r\n    } catch (err) {\r\n      this.logger.debug('[NLU::Rasa] Could not fetch model versions')\r\n      return []\r\n    }\r\n  }\r\n\r\n  async _isInSync(localIntents, remoteVersions) {\r\n    const intentsHash = crypto\r\n      .createHash('md5')\r\n      .update(JSON.stringify(localIntents))\r\n      .digest('hex')\r\n\r\n    const metadata = await this.kvs.get(RASA_HASH_KVS_KEY)\r\n\r\n    return metadata && metadata.hash === intentsHash && _.includes(remoteVersions, metadata.modelId)\r\n  }\r\n\r\n  async _onSyncSuccess(localIntents) {\r\n    const intentsHash = crypto\r\n      .createHash('md5')\r\n      .update(JSON.stringify(localIntents))\r\n      .digest('hex')\r\n\r\n    const versions = await this._getRemoteVersions()\r\n\r\n    const version = _.last(_.sortBy(versions))\r\n\r\n    if (!version) {\r\n      throw new Error('[NLU::Rasa] Could not sync model, could not list project models after training')\r\n    }\r\n\r\n    await this.kvs.set(RASA_HASH_KVS_KEY, {\r\n      hash: intentsHash,\r\n      modelId: version\r\n    })\r\n  }\r\n\r\n  async _cacheLatestModel() {\r\n    const metadata = await this.kvs.get(RASA_HASH_KVS_KEY)\r\n    if (!metadata) {\r\n      throw new Error('[NLU::Rasa] Could not fetch cached model: please make sure syncing succeeded first')\r\n    }\r\n    this._modelId = metadata.modelId\r\n    return metadata.modelId\r\n  }\r\n\r\n  async getCustomEntities() {\r\n    // RASA doesn't support custom entity types (version 0.10 as of writing)\r\n    return []\r\n  }\r\n\r\n  async sync() {\r\n    const intents = await this.storage.getIntents()\r\n    const remoteVersions = await this._getRemoteVersions()\r\n\r\n    if (await this._isInSync(intents, remoteVersions)) {\r\n      this.logger.debug('[NLU::Rasa] Model is up to date')\r\n      return\r\n    } else {\r\n      this.logger.debug('[NLU::Rasa] The model needs to be updated')\r\n    }\r\n\r\n    const sample = {\r\n      rasa_nlu_data: {\r\n        common_examples: [],\r\n        regex_features: [],\r\n        entity_synonyms: []\r\n      }\r\n    }\r\n\r\n    const common_examples = []\r\n\r\n    intents.forEach(intent => {\r\n      intent.utterances.forEach(utterance => {\r\n        const extracted = this.parser.extractLabelsFromCanonical(utterance, intent.entities)\r\n        const entities = []\r\n\r\n        extracted.labels.forEach(label => {\r\n          entities.push({\r\n            entity: label.entityName,\r\n            value: extracted.text.substr(label.start, label.end - label.start + 1),\r\n            start: label.start,\r\n            end: label.end + 1\r\n          })\r\n        })\r\n\r\n        common_examples.push({\r\n          text: extracted.text,\r\n          intent: intent.name,\r\n          entities: entities\r\n        })\r\n      })\r\n    })\r\n\r\n    if (this._training) {\r\n      return this.logger.warn('[NLU::Rasa] Training is already in progress, aborting this request')\r\n    } else {\r\n      this._training = true\r\n      this.logger.debug(`[NLU::Rasa] Started training model from ${common_examples.length} samples`)\r\n    }\r\n\r\n    try {\r\n      await this.client.post(\r\n        '/train',\r\n        {\r\n          rasa_nlu_data: {\r\n            common_examples: common_examples,\r\n            regex_features: [], // TODO Implement that\r\n            entity_synonyms: []\r\n          }\r\n        },\r\n        {\r\n          timeout: ms('30m'),\r\n          params: {\r\n            project: this._getProjectName()\r\n          }\r\n        }\r\n      )\r\n    } catch (err) {\r\n      this._training = false\r\n\r\n      const data = _.get(err, 'response.data')\r\n      const msg = `\"${data && JSON.stringify(data)}\" Status: ${err.status} | Message: ${err.message}`\r\n\r\n      if (err.status == 403) {\r\n        const errorMsg = `[NLU::Rasa] A model is already training, aborting sync: ${msg}`\r\n\r\n        this.logger.warn(errorMsg)\r\n        throw new Error(errorMsg)\r\n      }\r\n\r\n      if (err.status == 404) {\r\n        const errorMsg = `[NLU::Rasa] Invalid project error: ${msg}`\r\n\r\n        this.logger.warn(errorMsg)\r\n        throw new Error(errorMsg)\r\n      }\r\n\r\n      if (err.status == 500) {\r\n        const errorMsg = `[NLU::Rasa] Training error: ${msg}`\r\n\r\n        this.logger.warn(errorMsg)\r\n        throw new Error(errorMsg)\r\n      }\r\n\r\n      const errorMsg = `[NLU::Rasa] Error syncing model: ${msg}`\r\n\r\n      this.logger.error(errorMsg)\r\n      throw new Error(errorMsg)\r\n    }\r\n\r\n    this._training = false\r\n\r\n    await this._onSyncSuccess(intents)\r\n\r\n    const latestModel = await this._cacheLatestModel()\r\n\r\n    this.logger.info(`[NLU::Rasa] Synced model [Model=${latestModel}]`)\r\n  }\r\n\r\n  async extract(incomingEvent) {\r\n    let modelId = this._modelId\r\n\r\n    if (!modelId) {\r\n      modelId = await this._cacheLatestModel()\r\n    }\r\n\r\n    if (!modelId) {\r\n      const versions = await this._getRemoteVersions()\r\n\r\n      if (!versions.length) {\r\n        this.sync() // Async\r\n        this.logger.error(\r\n          '[NLU:Rasa] Your model needs to be trained at least once in this environment before extraction can be done'\r\n        )\r\n\r\n        return defaultExtractData('rasa')\r\n      }\r\n\r\n      this._modelId = modelId = _.last(_.sortBy(versions))\r\n      this.logger.warn(\r\n        '[NLU:Rasa] Model not specified, using latest one. Retrain in this environment to fix this warning.'\r\n      )\r\n\r\n      return defaultExtractData('rasa')\r\n    }\r\n\r\n    const res = await this.client.post('/parse', {\r\n      q: incomingEvent.text,\r\n      project: this._getProjectName(),\r\n      model: modelId\r\n    })\r\n\r\n    const intentName = _.get(res, 'data.intent.name') || 'None'\r\n    const confidence = _.get(res, 'data.intent.confidence') || 0\r\n    const intents = _.get(res, 'data.intent_ranking') || []\r\n    const entities = _.get(res, 'data.entities') || []\r\n\r\n    return {\r\n      intent: {\r\n        name: intentName,\r\n        confidence: parseFloat(confidence),\r\n        provider: 'rasa'\r\n      },\r\n      intents: intents.map(intent => ({\r\n        name: intent.name,\r\n        confidence: parseFloat(intent.confidence),\r\n        provider: 'rasa'\r\n      })),\r\n      entities: entities.map(entity => ({\r\n        name: null,\r\n        type: entity.entity,\r\n        value: entity.value,\r\n        original: entity.text,\r\n        confidence: null,\r\n        position: entity.start,\r\n        provider: entity.extractor\r\n      }))\r\n    }\r\n  }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/providers/rasa.js","module.exports = require(\"ms\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"ms\"\n// module id = 18\n// module chunks = 0","import _ from 'lodash'\r\nimport axios from 'axios'\r\nimport crypto from 'crypto'\r\nimport Promise from 'bluebird'\r\n\r\nimport Provider from './base'\r\n\r\nconst RECAST_HASH_KVS_KEY = 'nlu/recast/updateMetadata'\r\n\r\nexport default class RecastProvider extends Provider {\r\n  constructor(config) {\r\n    super({ ...config, name: 'recast', entityKey: '@recast' })\r\n\r\n    this.endpoint = `/users/${this.config.recastUserSlug}/bots/${this.config.recastBotSlug}`\r\n\r\n    this.client = axios.create({\r\n      baseURL: 'https://api.recast.ai/v2',\r\n      headers: { Authorization: `Token ${this.config.recastToken}` }\r\n    })\r\n  }\r\n\r\n  _getBotModel() {\r\n    return this.client.get(`${this.endpoint}`)\r\n  }\r\n\r\n  _getBulkCreations() {\r\n    return this.client.get(`${this.endpoint}/bulk_creations`)\r\n  }\r\n\r\n  _getRemoteIntents() {\r\n    return this.client.get(`${this.endpoint}/intents`)\r\n  }\r\n\r\n  _deleteIntent(intentSlug) {\r\n    return this.client.delete(`${this.endpoint}/intents/${intentSlug}`)\r\n  }\r\n\r\n  _postIntent(intent) {\r\n    return this.client.post(`${this.endpoint}/intents`, intent)\r\n  }\r\n\r\n  _getRemoteIntentExpressions(intentSlug) {\r\n    return this.client.get(`${this.endpoint}/intents/${intentSlug}/expressions`)\r\n  }\r\n\r\n  _getRemoteExpression(intentSlug, expressionId) {\r\n    return this.client.get(`${this.endpoint}/intents/${intentSlug}/expressions/${expressionId}`)\r\n  }\r\n\r\n  _updateRemoteExpression(intentSlug, expressionId, expression) {\r\n    return this.client.put(`${this.endpoint}/intents/${intentSlug}/expressions/${expressionId}`, expression)\r\n  }\r\n\r\n  _getRemoteGazettes() {\r\n    return this.client.get(`${this.endpoint}/gazettes`)\r\n  }\r\n\r\n  _deleteGazette(gazetteSlug) {\r\n    return this.client.delete(`${this.endpoint}/gazettes/${gazetteSlug}`)\r\n  }\r\n\r\n  async _postGazette(entity) {\r\n    try {\r\n      await this.client.post(`/entities`, { name: entity.entity_id })\r\n    } catch (err) {\r\n      // Entities names on recast are shared, so it's not really an error\r\n      if (err.response.data.message !== 'Entity has already been taken') {\r\n        this.syncing = false\r\n        throw new Error(err.response.data.message)\r\n      }\r\n    }\r\n\r\n    return this.client.post(`${this.endpoint}/gazettes`, entity)\r\n  }\r\n\r\n  async _getIntentsHash() {\r\n    const localIntents = await this.storage.getIntents()\r\n\r\n    return crypto\r\n      .createHash('md5')\r\n      .update(JSON.stringify(localIntents))\r\n      .digest('hex')\r\n  }\r\n\r\n  async _onSyncSuccess() {\r\n    const intentsHash = await this._getIntentsHash()\r\n\r\n    await this.kvs.set(RECAST_HASH_KVS_KEY, intentsHash)\r\n    this.syncing = false\r\n  }\r\n\r\n  /*******\r\n  Public API\r\n  *******/\r\n\r\n  async init() {\r\n    const { data: { results } } = await this._getBotModel()\r\n    this.defaultLanguage = results.language.isocode\r\n  }\r\n\r\n  async sync() {\r\n    if (this.syncing) {\r\n      this.logger.warn('[NLU::Recast] Model is already syncing !')\r\n      return\r\n    }\r\n\r\n    this.syncing = true\r\n    this.logger.debug('[NLU::Recast] Syncing Model...')\r\n\r\n    try {\r\n      // Delete all gazettes\r\n      let { data: { results: remoteGazettes } } = await this._getRemoteGazettes()\r\n\r\n      for (const e of _.map(remoteGazettes, 'slug')) {\r\n        await this._deleteGazette(e)\r\n      }\r\n\r\n      // Create entities and gazettes\r\n      const customEntities = await this.getCustomEntities()\r\n      remoteGazettes = []\r\n\r\n      for (const e of customEntities) {\r\n        const { data: { results: remoteGazette } } = await this._postGazette(e.definition)\r\n        remoteGazettes.push(_.pick(remoteGazette, ['slug', 'entity.id']))\r\n      }\r\n\r\n      // Delete then create intents and update expressions with entities\r\n      const localIntents = await this.storage.getIntents()\r\n      const { data: { results: remoteIntents } } = await this._getRemoteIntents()\r\n\r\n      // Delete all intents\r\n      for (const i of _.map(remoteIntents, 'slug')) {\r\n        await this._deleteIntent(i)\r\n      }\r\n\r\n      for (const intent of localIntents) {\r\n        if (intent.utterances.length === 0) {\r\n          this.logger.warn(`[NLU::Recast] Intent ${intent.name} has been skipped because it has no utterances`)\r\n          continue\r\n        }\r\n\r\n        // Post the intent\r\n        const utterances = _.map(intent.utterances, u => this.parser.extractLabelsFromCanonical(u, intent.entities))\r\n        const expressions = _.map(utterances, u => ({\r\n          source: u.text,\r\n          language: { isocode: this.defaultLanguage }\r\n        }))\r\n        await this._postIntent({ name: intent.name, expressions })\r\n\r\n        // Wait for the expressions of the intents to be created\r\n        while (true) {\r\n          const { data: { results } } = await this._getBulkCreations()\r\n\r\n          if (results.length === 0) {\r\n            break\r\n          }\r\n\r\n          await Promise.delay(1000)\r\n        }\r\n\r\n        // Update expressions with entities\r\n        const { data: { results: remoteIntentExpressions } } = await this._getRemoteIntentExpressions(intent.name)\r\n\r\n        for (const expr of remoteIntentExpressions) {\r\n          const utterance = utterances.find(u => u.text === expr.source)\r\n\r\n          if (utterance && utterance.labels.length) {\r\n            const { data: { results: remoteIntentExpression } } = await this._getRemoteExpression(intent.name, expr.id)\r\n\r\n            for (const label of utterance.labels) {\r\n              const word = utterance.text.substr(label.start, label.end - label.start + 1)\r\n              const token = remoteIntentExpression.tokens.find(t => t.word.name === word)\r\n\r\n              if (token && (!token.entity || token.entity.slug !== label.type)) {\r\n                const gazette = remoteGazettes.find(e => e.slug === label.type)\r\n                token.entity = { id: gazette.entity.id }\r\n                const expression = { source: expr.source, tokens: [token] }\r\n                await this._updateRemoteExpression(intent.name, expr.id, expression)\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    } catch (err) {\r\n      this.syncing = false\r\n      throw new Error(err.response.data.message)\r\n    }\r\n\r\n    await this._onSyncSuccess()\r\n\r\n    this.logger.info('[NLU::Recast] Synced Model')\r\n  }\r\n\r\n  async checkSyncNeeded() {\r\n    const intentsHash = await this._getIntentsHash()\r\n    const savedHash = await this.kvs.get(RECAST_HASH_KVS_KEY)\r\n\r\n    return savedHash !== intentsHash\r\n  }\r\n\r\n  async extract(incomingEvent) {\r\n    const { data: { results } } = await this.client.post('/request', {\r\n      text: incomingEvent.text\r\n    })\r\n\r\n    const intentName = _.get(results.intents[0], 'slug') || 'None'\r\n    const confidence = _.get(results.intents[0], 'confidence') || 0\r\n    const entities = []\r\n    _.forEach(results.entities, (value, key) => {\r\n      value.forEach(e => entities.push({ ...e, entityType: key }))\r\n    })\r\n\r\n    return {\r\n      intent: {\r\n        name: intentName,\r\n        confidence: confidence,\r\n        provider: 'recast'\r\n      },\r\n      intents: results.intents.map(intent => ({\r\n        name: intent.slug,\r\n        confidence: intent.confidence,\r\n        provider: 'recast'\r\n      })),\r\n      entities: entities.map(entity => {\r\n        let value = _.omit(entity, ['confidence', 'entityType', 'raw'])\r\n        const valueSize = _.size(value)\r\n        if (valueSize === 1) {\r\n          value = value[Object.keys(value)[0]]\r\n        } else if (valueSize === 0) {\r\n          value = entity.raw\r\n        }\r\n\r\n        return {\r\n          name: null,\r\n          type: entity.entityType,\r\n          value,\r\n          original: entity.raw,\r\n          confidence: entity.confidence,\r\n          position: null,\r\n          provider: 'recast'\r\n        }\r\n      }),\r\n      act: results.act, // Recast custom\r\n      type: results.type, // Recast custom\r\n      language: {\r\n        detected: results.language,\r\n        processed: results.processing_language\r\n      },\r\n      sentiment: results.sentiment // Recast custom\r\n    }\r\n  }\r\n\r\n  async getCustomEntities() {\r\n    return this.storage.getCustomEntities()\r\n  }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/providers/recast.js","import _ from 'lodash'\r\nimport crypto from 'crypto'\r\n\r\nimport zscore from 'zscore'\r\nimport natural from 'natural'\r\n\r\nimport Provider from './base'\r\n\r\nconst NATIVE_HASH_KVS_KEY = 'nlu/native/updateMetadata'\r\nconst NATIVE_MODEL = 'nlu/native/model'\r\nconst DEFAULT_THRESHOLD = 0.25\r\nconst EMPTY_INTENT = {\r\n  name: 'None',\r\n  confidence: 0,\r\n  provider: 'native'\r\n}\r\n\r\nexport default class NativeProvider extends Provider {\r\n  constructor(config) {\r\n    super({ ...config, name: 'native', entityKey: '@native' })\r\n    this.classifier = null\r\n  }\r\n\r\n  async init() {}\r\n\r\n  async checkSyncNeeded() {\r\n    const intents = await this.storage.getIntents()\r\n    return !await this._isInSync(intents)\r\n  }\r\n\r\n  _getProjectName() {\r\n    const scope = 'all'\r\n    return `${this.env}__${this.project}__${scope}`\r\n  }\r\n\r\n  setStemmer(stemmer) {\r\n    if (!stemmer) {\r\n      this.customStemmer = null\r\n    } else if (!_.isFunction(stemmer)) {\r\n      this.logger.error('[NLU::Native] Stemmer must be a function')\r\n      this.customStemmer = null\r\n    } else {\r\n      this.customStemmer = stemmer\r\n    }\r\n  }\r\n\r\n  getStemmer() {\r\n    return { tokenizeAndStem: this._stemText.bind(this) }\r\n  }\r\n\r\n  _stemText(text) {\r\n    if (this.customStemmer) {\r\n      return this.customStemmer(text)\r\n    } else {\r\n      return natural.PorterStemmer.tokenizeAndStem(text)\r\n    }\r\n  }\r\n\r\n  async _isInSync(localIntents) {\r\n    const intentsHash = crypto\r\n      .createHash('md5')\r\n      .update(JSON.stringify(localIntents))\r\n      .digest('hex')\r\n\r\n    const metadata = await this.kvs.get(NATIVE_HASH_KVS_KEY)\r\n    return metadata && metadata.hash === intentsHash\r\n  }\r\n\r\n  async _onSyncSuccess(localIntents) {\r\n    const intentsHash = crypto\r\n      .createHash('md5')\r\n      .update(JSON.stringify(localIntents))\r\n      .digest('hex')\r\n\r\n    // We save the model hash and model to the KVS\r\n    await this.kvs.set(NATIVE_HASH_KVS_KEY, { hash: intentsHash })\r\n    await this.kvs.set(NATIVE_MODEL, JSON.stringify(this.classifier))\r\n  }\r\n\r\n  async _restoreModel() {\r\n    const model = await this.kvs.get(NATIVE_MODEL)\r\n\r\n    if (!model) {\r\n      this.classifier = new natural.BayesClassifier()\r\n    }\r\n\r\n    this.classifier = natural.BayesClassifier.restore(JSON.parse(model), this.getStemmer())\r\n  }\r\n\r\n  async getCustomEntities() {\r\n    // Native NLU doesn't support entity extraction\r\n    return []\r\n  }\r\n\r\n  async sync() {\r\n    const intents = await this.storage.getIntents()\r\n\r\n    if (await this._isInSync(intents)) {\r\n      this.logger.debug('[NLU::Native] Model is up to date')\r\n      return\r\n    } else {\r\n      this.logger.debug('[NLU::Native] The model needs to be updated')\r\n    }\r\n\r\n    const classifier = new natural.BayesClassifier(this.getStemmer())\r\n\r\n    let samples_count = 0\r\n\r\n    intents.forEach(intent => {\r\n      intent.utterances.forEach(utterance => {\r\n        const extracted = this.parser.extractLabelsFromCanonical(utterance, intent.entities)\r\n        samples_count += 1\r\n        classifier.addDocument(this._stemText(extracted.text), intent.name)\r\n      })\r\n    })\r\n\r\n    this.logger.debug(`[NLU::Native] Started training model from ${samples_count} samples`)\r\n\r\n    try {\r\n      classifier.train()\r\n    } catch (err) {\r\n      return this.logger.error(`[NLU::Native] Error training model: ${err.message}`)\r\n    }\r\n\r\n    this.classifier = classifier\r\n\r\n    await this._onSyncSuccess(intents)\r\n\r\n    this.logger.info(`[NLU::Native] Synced model`)\r\n  }\r\n\r\n  async extract(incomingEvent) {\r\n    if (!this.classifier) {\r\n      if (await this.checkSyncNeeded()) {\r\n        await this.sync()\r\n      } else {\r\n        await this._restoreModel()\r\n      }\r\n    }\r\n\r\n    const threshold = parseFloat(this.nativeAdjustementThreshold || DEFAULT_THRESHOLD)\r\n\r\n    const classifications = _.orderBy(this.classifier.getClassifications(incomingEvent.text), ['value'], ['desc'])\r\n\r\n    let allScores = zscore(classifications.map(c => parseFloat(c.value)))\r\n\r\n    allScores = allScores.map((s, i) => {\r\n      const delta = Math.abs(s - allScores[i + 1] / s)\r\n      if (delta >= threshold) {\r\n        return s\r\n      }\r\n\r\n      const res =\r\n        s -\r\n        Math.max(0, allScores[i + 1] || 0) * 0.5 -\r\n        Math.max(0, allScores[i + 2] || 0) * 0.75 -\r\n        Math.max(0, allScores[i + 3] || 0)\r\n\r\n      if (res < 0) {\r\n        return 0\r\n      } else if (res > 1) {\r\n        return 1\r\n      } else {\r\n        return res\r\n      }\r\n    })\r\n\r\n    const intents = _.orderBy(\r\n      classifications.map((c, i) => ({\r\n        name: c.label,\r\n        confidence: allScores[i],\r\n        provider: 'native'\r\n      })),\r\n      ['confidence'],\r\n      'desc'\r\n    )\r\n\r\n    return {\r\n      intent: intents.length ? intents[0] : { ...EMPTY_INTENT },\r\n      intents,\r\n      entities: [] // Unsupported for now\r\n    }\r\n  }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/providers/native.js","module.exports = require(\"zscore\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"zscore\"\n// module id = 21\n// module chunks = 0","module.exports = require(\"natural\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"natural\"\n// module id = 22\n// module chunks = 0"],"sourceRoot":""}